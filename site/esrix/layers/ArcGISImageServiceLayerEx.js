define("dojo/_base/declare dojo/_base/config dojo/_base/lang dojo/_base/array dojo/dom dojo/dom-construct dojo/dom-attr dojo/dom-class dojo/dom-style dojo/has dojo/query dojo/Deferred esri/config esri/layers/ArcGISImageServiceLayer".split(" "),function(e,p,f,q,r,i,s,t,u,k,v,l,n,m){return!k("canvas2D")?e([m]):e(m,{nWorkers:0,onscrMode:!0,contrastValue:0,brightnessValue:0,sharpnessValue:0,_start:null,_image:null,_canvas:null,_givenCallback:null,_isProcessingInBG:!1,_isInternalRefresh:!1,_bgWorkers:null,
constructor:function(a,b){this._init();e.safeMixin(this,b)},getImageUrl:function(a,b,d,g){this.onscrMode?this._upgradeToOnScreenCanvas(b,d):this._givenCallback=g;this._isInternalRefresh?this._imageProcessingHandler():(arguments[3]=f.hitch(this,function(a){this._image.src=a}),this.inherited(arguments));this._isInternalRefresh=!1},refresh:function(){this._isProcessingInBG||this.inherited(arguments)},setContrastValue:function(a){this.contrastValue=parseInt(a,10);this.invalidate()},setBrightnessValue:function(a){this.brightnessValue=
parseInt(a,10);this.invalidate()},setContrastBrightness:function(a){this.brightnessValue=this.contrastValue=a;this.invalidate()},setSharpnessValue:function(a){this.sharpnessValue=parseFloat(a,10);this.invalidate()},invalidate:function(){this._isProcessingInBG||(!this._canvas||!this.onscrMode?(this._isInternalRefresh=!0,this.refresh()):this._imageProcessingHandler())},onPerformanceInfo:function(){},_onExtentChangeHandler:function(a,b,d){this.inherited(arguments)},_upgradeToOnScreenCanvas:function(){var a=
this._img_loading;this._canvas=i.create("canvas",{id:"rio_"+a.id,style:a.style.cssText});this._canvas._onload_connect=null;this._canvas._onerror_connect=null;this._canvas._onabort_connect=null;dojo.disconnect(a._onload_connect);dojo.disconnect(a._onerror_connect);dojo.disconnect(a._onabort_connect);dojo.destroy(a);this._img_loading=this._canvas},_init:function(){null===this._image&&(this._image=new Image,this._image.onload=f.hitch(this,this._imageProcessingHandler),this.onscrMode||(this._canvas=i.create("canvas")))},
_isProcessingRequired:function(){return this._isBCFilterEnabled()||this._isSharpenFilterEnabled()},_isBCFilterEnabled:function(){return 0!==this.contrastValue||0!==this.brightnessValue},_isSharpenFilterEnabled:function(){return 0<this.sharpnessValue},_imageProcessingHandler:function(){this._start=new Date;this._getProcessedPixels().then(f.hitch(this,function(a){this.onscrMode?this._onLoadHandler({currentTarget:this._canvas}):this._givenCallback(a)}))},_getProcessedPixels:function(){var a=new l;this._canvas.width=
this._image.width;this._canvas.height=this._image.height;var b=this._canvas.getContext("2d");b.drawImage(this._image,0,0);if(!this._isProcessingRequired())return a.resolve(this.onscrMode?null:this._canvas.toDataURL()),a;if(0<this.nWorkers&&k("webWorker"))return this._processInBG(this.nWorkers);var d=b.getImageData(0,0,this._canvas.width,this._canvas.height);this._isBCFilterEnabled()&&(Filters.CBFilter.applyContrastBrightness(d.data,this.contrastValue,this.brightnessValue),b.putImageData(d,0,0));if(this._isSharpenFilterEnabled()){var g=
b.getImageData(0,0,this._canvas.width,this._canvas.height);Filters.SharpenFilter.sharpen(d.data,g.data,{w:this._canvas.width,h:this._canvas.height},this.sharpnessValue);b.putImageData(d,0,0)}a.resolve(this.onscrMode?null:this._canvas.toDataURL());return a},_processInBG:function(a){var b=this._canvas,d=new l,a=1,g=3>a?!0:!1;if(null===this._bgWorkers){this._bgWorkers=[];for(var h=0;h<a;h++)this._bgWorkers[h]={connectionHandle:null,worker:new Worker(n.defaults.esrix.layers.ipBgWwProc)}}for(var e=0,f=
b.getContext("2d"),j=b.height/a,h=Filters.CBFilter.generateLookup(this.contrastValue,this.brightnessValue),c=0;c<a;c++){this._bgWorkers[c].connectionHandle=dojo.connect(this._bgWorkers[c].worker,"message",this,function(c){f.putImageData(c.data.result.imageData,0,j*c.data.wid);dojo.disconnect(this._bgWorkers[c.data.wid].connectionHandle);this._bgWorkers[c.data.wid].connectionHandle=null;e++;e==a&&(d.resolve(this.onscrMode?null:b.toDataURL()),this._isProcessingInBG=!1,g||(this._bgWorkers=null))});var i=
f.getImageData(0,j*c,b.width,j);this._bgWorkers[c].worker.postMessage({wid:c,cmd:"applyCBFilter",params:{imageData:i,lookupTable:h,contrast:this.contrastValue,brightness:this.brightnessValue},closeOnComplete:!g})}this._isProcessingInBG=!0;return d}})});
